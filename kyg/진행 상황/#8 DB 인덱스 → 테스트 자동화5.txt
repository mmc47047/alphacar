ë„¤ ğŸ‘ ë¡œê·¸ ë³´ë©´ ì •ìƒ ìº¡ì²˜ ì„±ê³µì´ì—ìš”.

Input #0, video4linux2,v4l2, from '/dev/video0': â€¦ yuyv422, 640x480, 30 fps â†’ ì¥ì¹˜ì—ì„œ ì˜ìƒ í”„ë ˆì„ì´ ì˜ ë“¤ì–´ì˜´

Output #0, mp4, to 'test.mp4': â€¦ â†’ ì¸ì½”ë”© ì„±ê³µ

ë§ˆì§€ë§‰ ì¤„ video:304kB â€¦ kb/s:857.27 â†’ 3ì´ˆì§œë¦¬ h264/mp4 íŒŒì¼ì´ 300KB ì •ë„ ë§Œë“¤ì–´ì¡ŒìŒ

ì¤‘ê°„ì— [Dequeued v4l2 buffer contains corrupted data] ê²½ê³ ëŠ” ë“œë¼ì´ë²„/ë²„í¼ ê´€ë ¨ì´ë¼ í° ë¬¸ì œëŠ” ì•„ë‹ˆê³ , íŒŒì¼ ìì²´ëŠ” ì •ìƒìœ¼ë¡œ ì €ì¥ëì–´ìš”. test.mp4ë¥¼ ì—´ì–´ë³´ë©´ 3ì´ˆ ì˜ìƒì´ ì˜ ì¬ìƒë  ê²ë‹ˆë‹¤.

âœ… ì´ì œ systemd ì„œë¹„ìŠ¤ë„ ì´ ë°©ì‹ìœ¼ë¡œ ê³ ì¹˜ë©´ ë©ë‹ˆë‹¤.
ì¦‰, YUYV ì…ë ¥ì„ libx264ë¡œ ì¸ì½”ë”©í•˜ëŠ” ExecStart:

# /etc/systemd/system/v2x-recorder.service
[Unit]
Description=V2X Circular Recorder (FFmpeg 10s segments)
After=network-online.target

[Service]
Type=simple
ExecStart=/usr/bin/ffmpeg -nostdin -y \
  -f v4l2 -input_format yuyv422 -framerate 30 -video_size 640x480 \
  -i /dev/video0 \
  -c:v libx264 -preset veryfast -crf 23 \
  -f segment -segment_time 10 -reset_timestamps 1 -strftime 1 \
  /var/rec/seg_%s.mp4
Restart=always
RestartSec=2
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target


ì ìš©:

sudo systemctl daemon-reload
sudo systemctl restart v2x-recorder.service
journalctl -u v2x-recorder.service -f


ì •ìƒì´ë¼ë©´ /var/rec/seg_<timestamp>.mp4 ê°€ 10ì´ˆë§ˆë‹¤ ê³„ì† ìƒê²¨ì•¼ í•©ë‹ˆë‹¤:

ls -lh /var/rec | tail


ğŸ‘‰ ì œì•ˆ:

ë¨¼ì € /var/recì— ì„¸ê·¸ë¨¼íŠ¸ê°€ ì˜ ìŒ“ì´ëŠ”ì§€ í™•ì¸

2~3ë¶„ ë…¹í™” í›„ emit_event.py --clip-hint ì‹¤í–‰í•´ì„œ /var/archive/accident_<ts>.mp4 ê°€ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸

ì›í•˜ë©´ ë‚´ê°€ ìµœì¢…ì ìœ¼ë¡œ ë…¹í™”+í´ë¦½+DB+ë¸Œë¡œë“œìºìŠ¤íŠ¸ê¹Œì§€ ëª¨ë‘ ëŒì•„ê°€ëŠ” end-to-end í…ŒìŠ¤íŠ¸ ì ˆì°¨ë¥¼ ì •ë¦¬í•´ì¤„ê¹Œìš”?

ì¢‹ì•„, ë…¹í™”ê°€ ì˜ êµ´ëŸ¬ê°€ê³  ìˆì–´! ì´ì œ ì‚¬ê±´ ì „í›„ ì˜ìƒ í´ë¦½ ìƒì„±ì„ ë¶™ì´ë©´ ëì´ì•¼.
ì§€ê¸ˆì€ ë…¹í™”ê°€ ëª‡ ë¶„ë°–ì— ì•ˆ ëìœ¼ë‹ˆ, ê°œë°œ ë‹¨ê³„ì—ì„  ì „í›„ 5ë¶„(ê¸°ë³¸ê°’ 300ì´ˆ) ëŒ€ì‹  ì§§ì€ ì°½(ì˜ˆ: 60ì´ˆ) ìœ¼ë¡œ ë¨¼ì € í…ŒìŠ¤íŠ¸í•´ë³´ì.

1) ì•„ì¹´ì´ë¸Œ í´ë” ì¤€ë¹„
sudo mkdir -p /var/archive
sudo chmod 777 /var/archive     # (ê°œë°œ ì¤‘ í¸ì˜ìš©, ìš´ì˜ì—ì„  755/ì†Œìœ ê¶Œ ì¡°ì •)

2) make_clip.pyì— ì „í›„ ê¸¸ì´ ì˜µì…˜ ì¶”ê°€(ê°œë°œ ëª¨ë“œ)

ì§€ê¸ˆ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì „í›„ 300ì´ˆ ê³ ì •ì´ë¼, ì¸ì ì˜µì…˜ì„ ì¶”ê°€í•´ ë¹ ë¥´ê²Œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆê²Œ ë°”ê¾¸ì.

sudo tee /opt/v2x/make_clip.py >/dev/null <<'EOF'
#!/usr/bin/env python3
import sys, os, time, math, subprocess, argparse

REC_DIR="/var/rec"; OUT_DIR="/var/archive"
os.makedirs(OUT_DIR, exist_ok=True)

def pick_segments(t0, pre, post, segdur=10):
    lo = int(math.floor((t0-pre)/segdur)*segdur)
    hi = int(math.ceil((t0+post)/segdur)*segdur)
    files=[]
    for ts in range(lo, hi, segdur):
        p = f"{REC_DIR}/seg_{ts}.mp4"
        if os.path.exists(p): files.append(p)
    return files

def concat(files, out):
    if not files:
        raise SystemExit("no segment files found for the requested window")
    tmp="/tmp/concat.txt"
    with open(tmp,"w") as f:
        for p in files: f.write(f"file '{p}'\n")
    # copy ì‹¤íŒ¨ì‹œ ì¬ì¸ì½”ë”©ìœ¼ë¡œ fallback
    r = subprocess.run(["ffmpeg","-y","-f","concat","-safe","0","-i",tmp,"-c","copy",out])
    if r.returncode != 0:
        subprocess.check_call(["ffmpeg","-y","-f","concat","-safe","0","-i",tmp,
                               "-c:v","libx264","-crf","23","-preset","veryfast",out])
    print("saved:", out)

if __name__=="__main__":
    ap = argparse.ArgumentParser()
    ap.add_argument("ts", type=float, nargs="?", default=time.time())
    ap.add_argument("--pre", type=int, default=300, help="seconds before ts")
    ap.add_argument("--post", type=int, default=300, help="seconds after ts")
    args = ap.parse_args()

    files = pick_segments(args.ts, args.pre, args.post)
    out = f"{OUT_DIR}/accident_{int(args.ts)}.mp4"
    concat(files, out)
EOF
sudo chmod +x /opt/v2x/make_clip.py

3) ìˆ˜ë™ìœ¼ë¡œ ì§§ì€ ì°½ìœ¼ë¡œ í´ë¦½ ìƒì„±(ë°”ë¡œ í™•ì¸)

í˜„ì¬ ì‹œê° ê¸°ì¤€ ì „í›„ 60ì´ˆë¡œ ì‹œí—˜:

python3 /opt/v2x/make_clip.py --pre 60 --post 60 $(date +%s)
ls -lh /var/archive | tail


saved: /var/archive/accident_<ts>.mp4 ë©”ì‹œì§€ ë‚˜ì˜¤ê³ , íŒŒì¼ì´ ë³´ì´ë©´ ì„±ê³µ!

ë§Œì•½ â€œno segment files foundâ€ê°€ ë‚˜ì˜¤ë©´ ë…¹í™”ê°€ ì¶©ë¶„íˆ ìŒ“ì´ì§€ ì•Šì€ ê±°ì•¼. 1~2ë¶„ ë” ë‘ê³  ë‹¤ì‹œ ì‹¤í–‰í•´ë´.

4) ì´ë²¤íŠ¸â†’ì›Œì²˜ê¹Œì§€ E2Eë¡œ í™•ì¸í•˜ë ¤ë©´

ì›Œì²˜ëŠ” make_clip.pyì— ì¸ìë¥¼ ì•ˆ ë„˜ê¸°ë¯€ë¡œ, ê¸°ë³¸ê°’(í˜„ì¬ 300ì´ˆ)ì„ ì”€.
ê°œë°œ ë‹¨ê³„ì—ì„  ê¸°ë³¸ê°’ì„ ì ê¹ 120ì´ˆë¡œ ë‚®ì¶° ë‘ì(ì „/í›„ 2ë¶„). ìœ„ ì½”ë“œì—ì„œ default=300ì„ default=120ìœ¼ë¡œ ë°”ê¾¸ê³  ì €ì¥í–ˆìœ¼ë©´:

sudo systemctl restart v2x-watcher.service
python3 /opt/v2x/emit_event.py --type collision --severity high --clip-hint
# ì ì‹œ ë’¤
ls -lh /var/archive | tail


DB ì¸ë±ìŠ¤ê¹Œì§€ ë¶™ì—¬ë’€ë‹¤ë©´:

python3 /opt/v2x/v2x_db_cli.py --recent 5

5) í”í•œ ì´ìŠˆ ì²´í¬

/var/rec ì„¸ê·¸ë¨¼íŠ¸ê°€ ì¶©ë¶„íˆ ìŒ“ì˜€ëŠ”ì§€(ìµœì†Œ ì „/í›„ í•©ê³„ë§Œí¼)

/var/archive ê¶Œí•œ/ê³µê°„

ffmpeg ì„¤ì¹˜/ê²½ë¡œ (which ffmpeg)

íŒŒì¼ í™•ì¥ì: ìœ„ make_clipì€ .mp4ë¡œ ì°¾ìŒ(ì§€ê¸ˆ ì„¸ê·¸ë¨¼íŠ¸ë„ .mp4ë¼ OK)

ì›í•˜ë©´, ì›Œì²˜ê°€ í˜¸ì¶œí•  ë•Œ ìë™ìœ¼ë¡œ ì§§ì€ ì°½ì„ ì“°ë„ë¡(ì˜ˆ: --pre 90 --post 90) ë³€ê²½í•œ ë²„ì „ë„ ë§Œë“¤ì–´ì¤„ê²Œ. ì§€ê¸ˆì€ ìˆ˜ë™ í…ŒìŠ¤íŠ¸ê°€ ìš°ì„ ì´ë¼ ì´ ì •ë„ë¡œ ë°”ë¡œ í™•ì¸ ê°€ëŠ¥í•´!

ì›ì¸ í™•ì •: /var/archive ì— ì“¸ ê¶Œí•œì´ ì—†ì–´ì„œ ffmpegê°€ ì¶œë ¥ íŒŒì¼ì„ ëª» ì—´ê³  ì‹¤íŒ¨í–ˆì–´ìš”(â€œPermission deniedâ€).

í•´ê²°ì€ ì…‹ ì¤‘ í•˜ë‚˜ë¡œ ë°”ë¡œ ë©ë‹ˆë‹¤.

ë°©ë²• 1) /var/archive ê¶Œí•œ ë¶€ì—¬ (ê¶Œì¥)

í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ í˜„ì¬ ì‚¬ìš©ìì—ê²Œ ì“°ê¸° ê¶Œí•œì„ ì£¼ì„¸ìš”.

sudo mkdir -p /var/archive
sudo chown $USER:$USER /var/archive
sudo chmod 775 /var/archive


ê·¸ ë‹¤ìŒ ë‹¤ì‹œ:

python3 /opt/v2x/make_clip.py --pre 60 --post 60 $(date +%s)
ls -lh /var/archive | tail

ë°©ë²• 2) ì§€ê¸ˆë§Œ rootë¡œ ì‹¤í–‰
sudo python3 /opt/v2x/make_clip.py --pre 60 --post 60 $(date +%s)


(ìš´ì˜ì—ì„  ê¶Œí•œ ì •ë¦¬í•˜ëŠ” ë°©ë²• 1ì´ ë” ê¹”ë”í•©ë‹ˆë‹¤.)

ë°©ë²• 3) ì¶œë ¥ ê²½ë¡œë¥¼ í™ˆìœ¼ë¡œ ë°”ê¾¸ê¸°

ì›í•œë‹¤ë©´ ìŠ¤í¬ë¦½íŠ¸ì— --out-dir ì˜µì…˜ì„ ì¶”ê°€í•´ì„œ í™ˆ ì•„ë˜ë¡œ ì €ì¥í•˜ê²Œ í•  ìˆ˜ ìˆì–´ìš”:

sudo tee /opt/v2x/make_clip.py >/dev/null <<'EOF'
#!/usr/bin/env python3
import sys, os, time, math, subprocess, argparse

REC_DIR="/var/rec"

def pick_segments(t0, pre, post, segdur=10):
    import math
    lo = int(math.floor((t0-pre)/segdur)*segdur)
    hi = int(math.ceil((t0+post)/segdur)*segdur)
    files=[]
    for ts in range(lo, hi, segdur):
        p = f"{REC_DIR}/seg_{ts}.mp4"
        if os.path.exists(p): files.append(p)
    return files

def concat(files, out):
    if not files:
        raise SystemExit("no segment files found for the requested window")
    tmp="/tmp/concat.txt"
    with open(tmp,"w") as f:
        for p in files: f.write(f"file '{p}'\n")
    r = subprocess.run(["ffmpeg","-y","-f","concat","-safe","0","-i",tmp,"-c","copy",out])
    if r.returncode != 0:
        subprocess.check_call(["ffmpeg","-y","-f","concat","-safe","0","-i",tmp,
                               "-c:v","libx264","-crf","23","-preset","veryfast",out])
    print("saved:", out)

if __name__=="__main__":
    ap = argparse.ArgumentParser()
    ap.add_argument("ts", type=float, nargs="?", default=time.time())
    ap.add_argument("--pre", type=int, default=300)
    ap.add_argument("--post", type=int, default=300)
    ap.add_argument("--out-dir", default="/var/archive")
    args = ap.parse_args()

    os.makedirs(args.out_dir, exist_ok=True)
    files = pick_segments(args.ts, args.pre, args.post)
    out = os.path.join(args.out_dir, f"accident_{int(args.ts)}.mp4")
    concat(files, out)
EOF
sudo chmod +x /opt/v2x/make_clip.py


ì´ì œ:

python3 /opt/v2x/make_clip.py --pre 60 --post 60 --out-dir /home/ubuntu11/archive $(date +%s)
ls -lh /home/ubuntu11/archive | tail

ì°¸ê³  (ì›Œì²˜ ì„œë¹„ìŠ¤ì™€ ê¶Œí•œ)

v2x-watcher.serviceê°€ rootë¡œ ëŒì•„ê°€ë©´ /var/archiveì— ì¨ë„ ê¶Œí•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.

ë°˜ëŒ€ë¡œ ì¼ë°˜ ì‚¬ìš©ìë¡œ ì›Œì²˜ë¥¼ ëŒë¦¬ë©´ /var/archive ê¶Œí•œì„ ì§€ê¸ˆì²˜ëŸ¼ ì—´ì–´ì¤˜ì•¼ í•´ìš”.

í˜¼ì¬ë¥¼ í”¼í•˜ë ¤ë©´: â€œì„œë²„ì˜ ìƒì„±ë¬¼(ì•„ì¹´ì´ë¸Œ/DB)ì€ ì „ë¶€ root ë˜ëŠ” ì „ìš© ìœ ì €â€ë¡œ í†µì¼í•˜ê±°ë‚˜, ê²½ë¡œë¥¼ í™ˆ í•˜ìœ„ë¡œ í†µì¼í•˜ëŠ” ê²ƒë„ ë°©ë²•ì…ë‹ˆë‹¤.

ê¶Œí•œ ì •ë¦¬ í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ ë³´ë©´ saved: /var/archive/accident_<ts>.mp4 ë©”ì‹œì§€ê°€ ëœ° ê±°ì˜ˆìš”.
