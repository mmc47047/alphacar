4-1) ìˆœí™˜ ë…¹í™”(FFmpeg) ì„œë¹„ìŠ¤ ë§Œë“¤ê¸°

CCTV/ì›¹ìº  ì˜ìƒì„ 10ì´ˆ ì„¸ê·¸ë¨¼íŠ¸ë¡œ ê³„ì† ì €ì¥(ë¡¤ë§). íŒŒì¼ëª…ì— epochë¥¼ ë„£ì–´ íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ìœ¼ë¡œ ì‰½ê²Œ ìë¥´ê¸°.

ì €ì¥ ê²½ë¡œ ë§Œë“¤ê¸°

sudo mkdir -p /var/rec /var/archive


ì„œë¹„ìŠ¤ ìœ ë‹› ìƒì„± (RTSP ì˜ˆì‹œ; USB ì›¹ìº ì´ë©´ ì£¼ì„ êµì²´)

sudo tee /etc/systemd/system/v2x-recorder.service >/dev/null <<'EOF'
[Unit]
Description=V2X Circular Recorder (FFmpeg 10s segments)
After=network-online.target

[Service]
Type=simple
# === RTSP ì…ë ¥ === (ì˜ˆ: rtsp://user:pass@CAM_IP/stream)
ExecStart=/usr/bin/ffmpeg -nostdin -y -rtsp_transport tcp -i "RTSP_URL_HERE" \
  -c copy -f segment -segment_time 10 -strftime 1 -reset_timestamps 1 \
  /var/rec/seg_%s.mp4
# === USB ì›¹ìº  ì…ë ¥(ìœ„ ëŒ€ì‹  ì´ ì¤„ë¡œ ë°”ê¿”ë„ ë¨) ===
# ExecStart=/usr/bin/ffmpeg -nostdin -y -f v4l2 -i /dev/video0 \
#  -c:v libx264 -preset veryfast -crf 23 \
#  -f segment -segment_time 10 -strftime 1 /var/rec/seg_%s.mp4
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF


ì ìš©/ì‹œì‘/í™•ì¸

sudo systemctl daemon-reload
sudo systemctl enable --now v2x-recorder.service
journalctl -u v2x-recorder.service -f
# ëª‡ ë¶„ ë’¤ íŒŒì¼ í™•ì¸
ls -lh /var/rec | tail

4-2) ì „í›„ 5ë¶„ í´ë¦½ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì„¤ì¹˜

ì´ë²¤íŠ¸ ì‹œê° ts ê¸°ì¤€ìœ¼ë¡œ T0-300s ~ T0+300s ë²”ìœ„ì˜ seg_* íŒŒì¼ì„ ëª¨ì•„ concat.

ìŠ¤í¬ë¦½íŠ¸ ì„¤ì¹˜

sudo tee /opt/v2x/make_clip.py >/dev/null <<'EOF'
#!/usr/bin/env python3
import sys, os, time, math, subprocess
REC_DIR="/var/rec"; OUT_DIR="/var/archive"
os.makedirs(OUT_DIR, exist_ok=True)

def pick_segments(t0, pre=300, post=300, segdur=10):
    lo = int(math.floor((t0-pre)/segdur)*segdur)
    hi = int(math.ceil((t0+post)/segdur)*segdur)
    files=[]
    for ts in range(lo, hi, segdur):
        p = f"{REC_DIR}/seg_{ts}.mp4"
        if os.path.exists(p): files.append(p)
    return files

def concat(files, out):
    if not files:
        raise SystemExit("no segment files found for the requested window")
    tmp="/tmp/concat.txt"
    with open(tmp,"w") as f:
        for p in files: f.write(f"file '{p}'\n")
    # copy ì‹¤íŒ¨ì‹œ ì¬ì¸ì½”ë”©ìœ¼ë¡œ fallback
    r = subprocess.run(["ffmpeg","-y","-f","concat","-safe","0","-i",tmp,"-c","copy",out])
    if r.returncode != 0:
        subprocess.check_call(["ffmpeg","-y","-f","concat","-safe","0","-i",tmp,"-c:v","libx264","-crf","23","-preset","veryfast",out])
    print("saved:", out)

if __name__=="__main__":
    t0 = float(sys.argv[1]) if len(sys.argv)>1 else time.time()
    files = pick_segments(t0)
    out = f"{OUT_DIR}/accident_{int(t0)}.mp4"
    concat(files, out)
EOF
sudo chmod +x /opt/v2x/make_clip.py


í…ŒìŠ¤íŠ¸ (ìµœê·¼ ì‹œê°ìœ¼ë¡œ í•œë²ˆ ë§Œë“¤ì–´ ë³´ê¸°)

python3 /opt/v2x/make_clip.py $(date +%s)
ls -lh /var/archive | tail

4-3) ì´ë²¤íŠ¸ ì›Œì²˜(íŒŒì¼ ë–¨ì–´ì§€ë©´ â†’ ë°©ì†¡ + í´ë¦½ ìƒì„±)

ê°ì§€ê¸°ê°€ /opt/v2x/events/*.json íŒŒì¼ì„ ë§Œë“¤ë©´:
(1) server.pyë¥¼ í˜¸ì¶œí•´ ë©€í‹°ìºìŠ¤íŠ¸ ë°©ì†¡, (2) make_clip.pyë¡œ 10ë¶„ í´ë¦½ ìƒì„±.

ì´ë²¤íŠ¸ ë””ë ‰í„°ë¦¬ & ì›Œì²˜ ì„¤ì¹˜

sudo mkdir -p /opt/v2x/events
sudo tee /opt/v2x/watch_and_broadcast.py >/dev/null <<'EOF'
#!/usr/bin/env python3
import time, json, subprocess, os
from pathlib import Path
EVENT_DIR = Path("/opt/v2x/events")
BROADCAST = ["/usr/bin/python3","/opt/v2x/server.py","--repeat"]  # ì„œë²„ ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ/ì˜µì…˜
CLIPPER   = ["/usr/bin/python3","/opt/v2x/make_clip.py"]
SEEN=set()

def broadcast(evt):
    cmd = BROADCAST + [
        "--type", evt.get("type","unknown"),
        "--severity", evt.get("severity","high"),
        "--distance-m", str(evt.get("distance_m",500)),
        "--road", evt.get("road","segment_A"),
        "--lat", str(evt.get("lat",0.0)),
        "--lon", str(evt.get("lon",0.0)),
        "--ttl-s","10.0"
    ]
    # HMAC í‚¤ë¥¼ server.envì— ì´ë¯¸ ë„£ì–´ systemdë¡œ ì‹¤í–‰ ì¤‘ì´ë©´ ìƒëµ ê°€ëŠ¥
    subprocess.Popen(cmd)

def make_clip(evt):
    ts = float(evt.get("ts", time.time()))
    subprocess.Popen(CLIPPER + [str(ts)])

def main():
    EVENT_DIR.mkdir(parents=True, exist_ok=True)
    while True:
        for p in EVENT_DIR.glob("*.json"):
            if p in SEEN:
                continue
            try:
                evt=json.loads(p.read_text())
            except Exception as e:
                print("[WARN] bad json:", p, e); 
                SEEN.add(p); continue
            broadcast(evt)
            if evt.get("clip_hint", True):
                make_clip(evt)
            SEEN.add(p)
        time.sleep(1)

if __name__=="__main__":
    main()
EOF
sudo chmod +x /opt/v2x/watch_and_broadcast.py


ì›Œì²˜ systemd ìœ ë‹›

sudo tee /etc/systemd/system/v2x-watcher.service >/dev/null <<'EOF'
[Unit]
Description=V2X Event Watcher (trigger broadcast + clip)
After=v2x-recorder.service network-online.target
Wants=v2x-recorder.service

[Service]
WorkingDirectory=/opt/v2x
ExecStart=/usr/bin/python3 /opt/v2x/watch_and_broadcast.py
Restart=always
RestartSec=1

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now v2x-watcher.service
journalctl -u v2x-watcher.service -f


í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ë“œë¡­(ê°ì§€ê¸° í‰ë‚´)

sudo tee /opt/v2x/events/test_collision.json >/dev/null <<'EOF'
{"ts": '"$(date +%s)"', "type":"collision", "severity":"high",
 "lat":37.12, "lon":127.12, "road":"segment_A", "distance_m":500, "clip_hint":true}
EOF


ê¸°ëŒ€ ê²°ê³¼:

ì°¨ëŸ‰ ìª½ journalctl -u v2x-alert-client.service -f ì—ì„œ [RECV] ... ë¡œê·¸ê°€ ì¦‰ì‹œ ë³´ì„

ì„œë²„ ìª½ /var/archive/accident_<ts>.mp4 ê°€ ì ì‹œ í›„ ìƒì„±

4-4) ê°ì§€ê¸°(Detection/Classification)ì™€ ì—°ê²°í•˜ëŠ” ë°©ë²•

ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•: ê°ì§€ê¸°ê°€ ì‚¬ê³  í™•ì • ì‹œ ìœ„ JSON í¬ë§·ìœ¼ë¡œ /opt/v2x/events/<ì–´ë–¤ì´ë¦„>.json í•œ ì¤„ ì“°ê¸°

{"ts": 1737930000.123, "type":"fire", "severity":"critical",
 "lat":37.12, "lon":127.12, "road":"segment_B", "distance_m":300, "clip_hint":true}


ê°ì§€ê¸°ê°€ Pythonì´ë©´:

import json, time, uuid, pathlib
evt={"ts":time.time(),"type":"collision","severity":"high","lat":37.12,"lon":127.12,"road":"A","distance_m":500,"clip_hint":True}
pathlib.Path(f"/opt/v2x/events/{uuid.uuid4().hex}.json").write_text(json.dumps(evt))

4-5) ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œ & ì²´í¬

/var/recê°€ ë¹„ì–´ìˆë‹¤ â†’ v2x-recorder.service ë¡œê·¸ í™•ì¸(ì¹´ë©”ë¼ URL/ê¶Œí•œ/ì½”ë±)

í´ë¦½ì´ ì•ˆ ë§Œë“¤ì–´ì§„ë‹¤ â†’ make_clip.pyë¥¼ ìˆ˜ë™ ì‹¤í–‰í•´ì„œ ì—ëŸ¬ í™•ì¸

ë°©ì†¡ì€ ë˜ëŠ”ë° ì°¨ëŸ‰ì´ ì•ˆ ë°›ëŠ”ë‹¤ â†’ APì˜ ë©€í‹°ìºìŠ¤íŠ¸/IGMP ì„¤ì •, --iface ëª…ì‹œ, ë°©í™”ë²½ í™•ì¸

ë°©ì†¡ì´ ë„ˆë¬´ ì¦ë‹¤ â†’ ì„œë²„ --repeat ëŒ€ì‹  ì›Œì²˜ì—ì„œ ë‹¨ë°œë¡œ í˜¸ì¶œí•˜ë„ë¡ ë°”ê¿”ë„ ë¨(í•„ìš”ì‹œ ìˆ˜ì •í•´ ì¤„ê²Œ)

ì¢‹ì•„, 4-4(ê°ì§€ê¸° â†” ì´ë²¤íŠ¸ JSON ë“œë¡­ ì—°ë™) ëŠ” â€œì‚¬ê³ ê°€ í™•ì •ë˜ë©´ /opt/v2x/events/*.json íŒŒì¼ì„ í•˜ë‚˜ ì“°ëŠ” ê²ƒâ€ë§Œ í•˜ë©´ ëì´ì—ìš”.
ì•„ë˜ ë‘˜ ì¤‘ í¸í•œ ìª½ìœ¼ë¡œ ë°”ë¡œ ì§„í–‰í•˜ë©´ ë©ë‹ˆë‹¤.

ì˜µì…˜ A) ê°€ì¥ ì‰¬ìš´ ë°©ë²• â€” ì´ë²¤íŠ¸ ë°œì‚¬ê¸°(ë”ë¯¸/ìˆ˜ë™)

ê°ì§€ê¸°ê°€ ì•„ì§ ì—†ì–´ë„ ì›Œì²˜ê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ ê²€ì¦ ê°€ëŠ¥.

íŒŒì¼ ìƒì„±ê¸° ìŠ¤í¬ë¦½íŠ¸(ì„œë²„):

sudo tee /opt/v2x/emit_event.py >/dev/null <<'EOF'
#!/usr/bin/env python3
import json, time, uuid, pathlib, argparse
p = argparse.ArgumentParser()
p.add_argument("--type", default="collision", choices=["collision","fire","rollover","blockage","unknown"])
p.add_argument("--severity", default="high")
p.add_argument("--lat", type=float, default=37.12345)
p.add_argument("--lon", type=float, default=127.12345)
p.add_argument("--road", default="segment_A")
p.add_argument("--distance-m", type=float, default=500)
p.add_argument("--ts", type=float, default=time.time())
p.add_argument("--clip-hint", action="store_true")
args = p.parse_args()

evt = {
  "ts": args.ts,
  "type": args.type,
  "severity": args.severity,
  "lat": args.lat, "lon": args.lon,
  "road": args.road,
  "distance_m": args.distance_m,
  "clip_hint": bool(args.clip_hint),
}
out = pathlib.Path("/opt/v2x/events") / f"{uuid.uuid4().hex}.json"
out.write_text(json.dumps(evt))
print("wrote", out)
EOF
sudo chmod +x /opt/v2x/emit_event.py


ë°œì‚¬(í…ŒìŠ¤íŠ¸):

python3 /opt/v2x/emit_event.py --type collision --severity high --clip-hint


ê¸°ëŒ€ ê²°ê³¼:

ì°¨ëŸ‰ ë¡œê·¸ì— [RECV] ... ë°”ë¡œ í‘œì‹œ

ì„œë²„ /var/archive/accident_<ts>.mp4 ìƒì„±(ë…¹í™”ê°€ ëŒê³  ìˆë‹¤ë©´)

ì˜µì…˜ B) ê°„ë‹¨ ê°ì§€ê¸° ìŠ¤í…(ì¹´ë©”ë¼/ì˜ìƒ ì…ë ¥ â†’ ê·œì¹™ ê¸°ë°˜ â†’ ì´ë²¤íŠ¸ ë“œë¡­)

ì‹¤ì œ ê°ì§€ê¸° ë¶™ì´ê¸° ì „, OpenCVë¡œ â€œì—°ì† ì •ì§€/ì—°ê¸° ìƒ‰ìƒâ€ ê°™ì€ ê°„ë‹¨ ê·œì¹™ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ë§Œë“œëŠ” ì˜ˆ.

sudo tee /opt/v2x/detector_stub.py >/dev/null <<'EOF'
#!/usr/bin/env python3
import cv2, time, json, uuid, pathlib, argparse, numpy as np

EVENT_DIR = pathlib.Path("/opt/v2x/events"); EVENT_DIR.mkdir(parents=True, exist_ok=True)

def drop_event(evt:dict):
    p = EVENT_DIR / f"{uuid.uuid4().hex}.json"
    evt.setdefault("ts", time.time())
    p.write_text(json.dumps(evt))
    print("[EVENT]", evt)

def main():
    a = argparse.ArgumentParser()
    a.add_argument("--src", default=0, help="camera index or video path or rtsp url")
    a.add_argument("--road", default="segment_A")
    a.add_argument("--lat", type=float, default=37.12345)
    a.add_argument("--lon", type=float, default=127.12345)
    a.add_argument("--distance-m", type=float, default=500)
    args = a.parse_args()

    cap = cv2.VideoCapture(args.src)
    if not cap.isOpened():
        raise SystemExit(f"cannot open src={args.src}")

    # ê°„ë‹¨ ëª¨ì…˜/ì •ì§€ íŒë‹¨ ë³€ìˆ˜
    prev = None
    still_frames = 0
    FIRE_COUNT = 0

    while True:
        ok, frame = cap.read()
        if not ok: break

        # --- ê°„ë‹¨ í™”ì¬ íŒíŠ¸(ë¶‰ì€ìƒ‰ ë§ì€ í”„ë ˆì„ ëˆ„ì ) ---
        hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)
        mask_red = cv2.inRange(hsv, (0,70,50), (10,255,255)) + cv2.inRange(hsv, (170,70,50), (180,255,255))
        red_ratio = (mask_red>0).mean()
        if red_ratio > 0.20:   # í”„ë ˆì„ì˜ 20% ì´ìƒì´ ë¶‰ì€ ê³„ì—´ì´ë©´ íŒíŠ¸
            FIRE_COUNT += 1
        else:
            FIRE_COUNT = max(0, FIRE_COUNT-1)
        if FIRE_COUNT >= 10:   # ì•½ 10í”„ë ˆì„ ì§€ì†(â‰ˆ0.3s~0.5s) ì‹œ ì´ë²¤íŠ¸
            drop_event({
              "type":"fire","severity":"high",
              "lat":args.lat,"lon":args.lon,"road":args.road,
              "distance_m":args.distance_m,"clip_hint":True
            })
            FIRE_COUNT = 0

        # --- ê°„ë‹¨ ì¶©ëŒ/ì •ì§€ íŒíŠ¸(í”„ë ˆì„ ì°¨ì´ ê±°ì˜ ì—†ìŒì´ ì§€ì†) ---
        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
        gray = cv2.GaussianBlur(gray, (5,5), 0)
        if prev is not None:
            diff = cv2.absdiff(prev, gray)
            motion = (diff>25).mean()
            if motion < 0.005:   # ëª¨ì…˜ í”½ì…€ ë¹„ìœ¨ì´ ë§¤ìš° ë‚®ìœ¼ë©´ 'ì •ì§€'ë¡œ ê°„ì£¼
                still_frames += 1
            else:
                still_frames = 0
            # 3ì´ˆ ê°€ëŸ‰ ì •ì§€ ì§€ì†ë˜ë©´ 'blockage/collision ì˜ì‹¬' ì´ë²¤íŠ¸
            if still_frames >= 90:
                drop_event({
                  "type":"collision","severity":"medium",
                  "lat":args.lat,"lon":args.lon,"road":args.road,
                  "distance_m":args.distance_m,"clip_hint":True
                })
                still_frames = 0
        prev = gray

        # í‚¤ ì¢…ë£Œ(í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œë§Œ)
        if cv2.waitKey(1) & 0xFF == 27:  # ESC
            break

    cap.release()
EOF
sudo chmod +x /opt/v2x/detector_stub.py


ì‹¤í–‰:

# ì›¹ìº ì´ë©´
python3 /opt/v2x/detector_stub.py --src 0
# íŒŒì¼/RTSPë©´
# python3 /opt/v2x/detector_stub.py --src /path/to/video.mp4
# python3 /opt/v2x/detector_stub.py --src "rtsp://user:pass@CAM_IP/stream"


í”„ë ˆì„ì— ë¶‰ì€ ì˜ì—­ì´ í° ë¹„ìœ¨ë¡œ ì§€ì†ë˜ë©´ fire,

ëª¨ì…˜ì´ ê±°ì˜ ì—†ìœ¼ë©´ ëª‡ ì´ˆ í›„ collision ì˜ì‹¬ ì´ë²¤íŠ¸ë¥¼ /opt/v2x/events/ì— ë“œë¡­ â†’ ì›Œì²˜ê°€ ë¸Œë¡œë“œìºìŠ¤íŠ¸ + 10ë¶„ í´ë¦½ ì²˜ë¦¬.

ì‹¤ì œ ê°ì§€ê¸°ë¡œ ëŒ€ì²´í•  ë•Œ(ìš”ì§€)

ë„¤ê°€ ì“°ëŠ” Detection/Classification ì½”ë“œ(ì˜ˆ: YOLO/TensorRT/ONNX Runtime)ì—ì„œ â€œì‚¬ê³  í™•ì •â€ ì‹œì ì— ë”± í•œ ì¤„:

import json, time, uuid, pathlib
evt={"ts":time.time(),"type":"collision","severity":"high",
     "lat":37.12,"lon":127.12,"road":"A","distance_m":500,"clip_hint":True}
pathlib.Path(f"/opt/v2x/events/{uuid.uuid4().hex}.json").write_text(json.dumps(evt))


ì´ í•œ ì¤„ì´ 4-3ì˜ ì›Œì²˜ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.

ì²´í¬ë¦¬ìŠ¤íŠ¸

/opt/v2x/watch_and_broadcast.py ì„œë¹„ìŠ¤ê°€ í™œì„±ì¸ì§€ í™•ì¸:

systemctl status v2x-watcher.service
journalctl -u v2x-watcher.service -f


ì´ë²¤íŠ¸ê°€ ë–¨ì–´ì§€ë©´ ì°¨ëŸ‰ ì½˜ì†”ì— [RECV] ...ê°€ ì¦‰ì‹œ ë‚˜ì˜¤ê³ , /var/archive/accident_<ts>.mp4ê°€ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸.

ì¢‹ìŠµë‹ˆë‹¤ ğŸ‘ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ë©´ ì›ì¸ì€ ì•„ì£¼ ë‹¨ìˆœí•´ìš”:

PermissionError: [Errno 13] Permission denied: '/opt/v2x/events/...json'


ì¦‰, ì§€ê¸ˆ ë¡œê·¸ì¸í•œ ê³„ì •(puttyì—ì„œ ì“°ëŠ” ê³„ì •)ì´ /opt/v2x/events/ ë””ë ‰í† ë¦¬ì— ì“¸ ê¶Œí•œì´ ì—†ë‹¤ëŠ” ê²ë‹ˆë‹¤.

í•´ê²° ë°©ë²• 2ê°€ì§€
ë°©ë²• 1) ë””ë ‰í† ë¦¬ ê¶Œí•œì„ ì—´ì–´ì£¼ê¸° (ê°€ì¥ ê°„ë‹¨)
sudo mkdir -p /opt/v2x/events
sudo chown -R $USER:$USER /opt/v2x/events
sudo chmod 755 /opt/v2x/events


â†’ ì´ë ‡ê²Œ í•˜ë©´ í˜„ì¬ ê³„ì •ì´ /opt/v2x/events/ì— íŒŒì¼ì„ ììœ ë¡­ê²Œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ê·¸ ë‹¤ìŒ ë‹¤ì‹œ ì‹¤í–‰:

python3 /opt/v2x/emit_event.py --type collision --severity high --clip-hint

ë°©ë²• 2) ê·¸ëŒ€ë¡œ root ê³„ì •ìœ¼ë¡œ ì‹¤í–‰
sudo python3 /opt/v2x/emit_event.py --type collision --severity high --clip-hint


â†’ ì´ë ‡ê²Œ í•˜ë©´ PermissionError ì—†ì´ JSONì´ /opt/v2x/events/ì— ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.

ì¶”ì²œ

ê°œë°œ/í…ŒìŠ¤íŠ¸ ì¤‘ì´ë¼ë©´ **ë°©ë²• 1 (ê¶Œí•œ ë³€ê²½)**ì´ í¸í•©ë‹ˆë‹¤.

ìš´ì˜í™˜ê²½ì—ì„œ systemd ì„œë¹„ìŠ¤ë¡œ ê°ì§€ê¸°ë¥¼ ëŒë¦´ ì˜ˆì •ì´ë©´ â†’ Service ì•ˆì—ì„œ User=ë¥¼ ëª…ì‹œí•˜ê±°ë‚˜, root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” êµ¬ì¡°ë¡œ ê°€ëŠ” ê²Œ ì¼ë°˜ì ì´ì—ìš”.
